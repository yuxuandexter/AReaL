
resources:
  accelerators: A100:8
  image_id: docker:ghcr.io/inclusionai/areal-runtime:v0.4.1
  memory: 32+
  cpus: 8+

num_nodes: 2

workdir: .

file_mounts:
  /storage: # Should be consistent with the storage paths set in gsm8k_grpo_ray.yaml
    source: s3://my-bucket/  # or gs://, https://<azure_storage_account>.blob.core.windows.net/<container>, r2://, cos://<region>/<bucket>, oci://<bucket_name>
    mode: MOUNT  # MOUNT or COPY or MOUNT_CACHED. Defaults to MOUNT. Optional.

run: |
  # Get the Head node's IP and total number of nodes (environment variables injected by SkyPilot).
  head_ip=$(echo "$SKYPILOT_NODE_IPS" | head -n1)

  if [ "$SKYPILOT_NODE_RANK" = "0" ]; then
    echo "Starting Ray head node..."
    ray start --head --port=6379

    while [ $(ray status | grep node_ | wc -l) -lt $SKYPILOT_NUM_NODES ]; do
      echo "Waiting for all nodes to join... Current nodes: $(ray status | grep node_ | wc -l) / $SKYPILOT_NUM_NODES"
      sleep 5
    done

    echo "Executing training script on head node..."
    python3 -m areal.launcher.ray examples/math/gsm8k_grpo.py \
            --config examples/skypilot/gsm8k_grpo_ray.yaml \
            experiment_name=gsm8k-grpo \
            trial_name=trial0 \
            cluster.n_nodes=$SKYPILOT_NUM_NODES \
            cluster.n_gpus_per_node=$SKYPILOT_NUM_GPUS_PER_NODE \
            allocation_mode=sglang:d8+d8
  else
    sleep 10
    echo "Starting Ray worker node..."
    ray start --address $head_ip:6379
    sleep 5
  fi

  echo "Node setup complete for rank $SKYPILOT_NODE_RANK."
